{% extends "sitebase.html" %}

{% load i18n %}
{% load crispy_forms_tags %}
{% load static %}

{% block page_title %}Account Details and Preferences{% endblock %}

{%block navigation %}{% include '_nav-activate.html' %} {% endblock %}

{% block extra_css_or_js %}

<!-- Custom CSS for User Profile Form -->
<link rel="stylesheet" href="{% static 'css/userprofile-form.css' %}">

<script async src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&loading=async&callback=initialize"></script>

<script>

var geocoder;
var map;

function initialize() {
    geocoder = new google.maps.Geocoder();
}

function codeAddress() {
    var city = document.getElementById('id_city').value;
    var state = document.getElementById('id_state').value;
    var zipcode = document.getElementById('id_zipcode').value;
    var country = document.getElementById('id_country').value;

    // Don't include "NA" values in geocoding
    if (city.toUpperCase() == 'NA') city = "";
    if (state.toUpperCase() == 'NA') state = "";

    var address = city.concat(', ').concat(state).concat(' ').concat(zipcode).concat(' ').concat(country);

    console.log(address);

    geocoder.geocode({
        'address': address
    }, function (results, status) {
        if (status == "OK") {
            $("#id_position").val(results[0].geometry.location);
            document.getElementById("UPForm").submit();
        } else {
            alert('Geocode was not successful for the following reason: ' + status);
        }
    });
}

// City-state countries that don't need a separate city field
const CITY_STATE_COUNTRIES = [
    'singapore',
    'monaco',
    'san marino',
    'vatican city',
    'vatican'
];

// Check if country is a city-state
function isCityState(country) {
    if (!country) return false;
    const countryLower = country.toLowerCase().trim();
    return CITY_STATE_COUNTRIES.some(cs => countryLower.includes(cs));
}

// Update city field requirement based on country
function updateCityFieldRequirement() {
    const countryInput = document.getElementById('id_country');
    const cityControl = document.getElementById('div_id_city');
    const cityInput = document.getElementById('id_city');

    if (!countryInput || !cityControl) return;

    const country = countryInput.value;
    const isCityStateCountry = isCityState(country);

    if (isCityStateCountry) {
        // Make city optional for city-states
        cityControl.classList.remove('required-field');
        cityControl.classList.add('optional-field');
        cityInput.removeAttribute('aria-required');
    } else {
        // Make city required for other countries
        cityControl.classList.remove('optional-field');
        cityControl.classList.add('required-field');
        cityInput.setAttribute('aria-required', 'true');
    }
}

// Real-time validation feedback
function addValidationFeedback(inputId, isValid) {
    const control = document.getElementById('div_id_' + inputId);
    if (!control) return;

    if (isValid) {
        control.classList.remove('field-error');
        control.classList.add('field-valid');
    } else {
        control.classList.remove('field-valid');
        control.classList.add('field-error');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for country changes
    const countryInput = document.getElementById('id_country');
    if (countryInput) {
        countryInput.addEventListener('input', updateCityFieldRequirement);
        countryInput.addEventListener('blur', updateCityFieldRequirement);

        // Check initial state
        updateCityFieldRequirement();
    }

    // Add real-time validation
    const requiredFields = ['first', 'last', 'country', 'zipcode', 'state'];
    requiredFields.forEach(fieldId => {
        const input = document.getElementById('id_' + fieldId);
        if (input) {
            input.addEventListener('blur', function() {
                const isValid = this.value.trim() !== '';
                addValidationFeedback(fieldId, isValid);
            });
        }
    });

    // City field validation depends on country
    const cityInput = document.getElementById('id_city');
    if (cityInput) {
        cityInput.addEventListener('blur', function() {
            const country = document.getElementById('id_country').value;
            const isCityStateCountry = isCityState(country);
            const cityValue = this.value.trim();

            // Valid if: city-state country OR has value
            const isValid = isCityStateCountry || cityValue !== '';
            addValidationFeedback('city', isValid);
        });
    }
});

</script>

{% endblock %}

{% block content %}

<div class="row-fluid">
    <div class="col-md-8 col-lg-6">

        <!-- Page Header -->
        <h2 class="form-page-title">Complete Your Profile</h2>

        <!-- Explanatory Message -->
        <div class="profile-explanation">
            <h4 class="explanation-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                Why we need your location
            </h4>
            <p>The Close Call Database is a <strong>location-based mapping service</strong> for cyclist safety. Your location information helps us:</p>
            <ul>
                <li><strong>Show relevant incidents</strong> near you on the map</li>
                <li><strong>Send timely alerts</strong> about dangerous areas in your community</li>
                <li><strong>Build a safety network</strong> connecting cyclists in your area</li>
            </ul>
        </div>

        <!-- Validation Messages -->
        {% if messages %}
        <div class="validation-messages">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" role="alert">
                <strong>{{ message|safe }}</strong>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Form -->
        <form action="" id="UPForm" method="POST" class="userprofile-form" novalidate>
            {% csrf_token %}

            <p class="form-required-notice">All fields required</p>

            <div class="form-section">
                <h3 class="section-title">Personal Information</h3>

                <div class="form-row">
                    <div id="div_id_first" class="form-group required-field">
                        <label for="id_first" class="control-label">First Name</label>
                        {{ form.first }}
                    </div>

                    <div id="div_id_last" class="form-group required-field">
                        <label for="id_last" class="control-label">Last Name</label>
                        {{ form.last }}
                    </div>
                </div>
                <span class="help-block">Use your real name (as you would on an official report)</span>
            </div>

            <div class="form-section">
                <h3 class="section-title">Location Information</h3>
                <p class="section-description">Used for incident alerts and mapping</p>

                <div id="div_id_country" class="form-group required-field">
                    <label for="id_country" class="control-label">Country</label>
                    {{ form.country }}
                    <span class="help-block">e.g., United States, United Kingdom, France</span>
                </div>

                <div id="div_id_city" class="form-group required-field">
                    <label for="id_city" class="control-label">City</label>
                    {{ form.city }}
                    <span class="help-block">Your city or nearest major city</span>
                </div>

                <div id="div_id_state" class="form-group required-field">
                    <label for="id_state" class="control-label">State / Province / Region</label>
                    {{ form.state }}
                    <span class="help-block">e.g., NY, CA, CO, Ontario, Victoria</span>
                </div>

                <div id="div_id_zipcode" class="form-group required-field">
                    <label for="id_zipcode" class="control-label">Zip / Postal Code</label>
                    {{ form.zipcode }}
                    <span class="help-block">Needed for accurate location-based notifications</span>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">Notification Preferences</h3>

                <div id="div_id_email_incidents" class="form-group optional-field">
                    <div class="checkbox">
                        <label for="id_email_incidents">
                            {{ form.email_incidents }}
                            <span class="checkbox-label">Email me about new incidents near my location</span>
                        </label>
                    </div>
                    <span class="help-block">Receive alerts when incidents are reported in your area</span>
                </div>
            </div>

            <!-- Hidden position field for geocoding -->
            {{ form.position }}

            <div class="form-actions">
                <button type="button" class="btn btn-primary btn-lg" onclick="codeAddress()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Save Profile
                </button>
            </div>
        </form>

    </div>
</div>

{% endblock %}
